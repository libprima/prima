task:

  name: "Cirrus tests"
  trigger_type: manual

  # Perform the task only if the folders or files specified below are changed
  # See https://cirrus-ci.org/guide/writing-tasks/#conditional-task-execution
  ## skip: the task will be created / triggered, but its execution will be skipped, and it will be marked as successful.
  ##skip: "!changesInclude('.cirrus.yml', 'fortran/**', 'c/**', 'python/**')"
  # only_if: the task will not be created / triggered.
  only_if: "changesInclude('.cirrus.yml', 'fortran/**', 'c/**', 'python/**')"

  timeout_in: 120m  # There is a hard limit of 2 hours for free tasks.

  matrix:  # We test the platforms not available on GitHub Actions.
    - name: AMD64 Debian
      container:
        image: debian:latest

    - name: ARM64 Debian
      arm_container:
        image: debian:latest

    - name: AMD64 Fedora
      container:
        image: fedora:latest

    - name: ARM64 Fedora
      arm_container:
        image: fedora:latest

    - name: AMD64 Alpine
      container:
        image: alpine:latest

    - name: ARM64 Alpine
      arm_container:
        image: alpine:latest

    - name: AMD64 FreeBSD
      freebsd_instance:
        #image_family: freebsd-16-0-snap  # INVALID_ARGUMENT: Snap images are not supported due to boot stability.
        image_family: freebsd-15-0-amd64-ufs
        architecture: amd64

    # The following seems not available as of 20240409. See
    # https://github.com/cirruslabs/cirrus-ci-docs/issues/906
    # https://cirrus-ci.com/task/6720657520590848
    # - name: ARM64 FreeBSD
    #   freebsd_instance:
    #     image_family: freebsd-14-0
    #     architecture: arm64

  dependencies_script: |
    set -euo pipefail

    echo "MK=make" >> $CIRRUS_ENV

    uname -a
    cat /etc/os-release || true

    if [ "$(uname)" == "FreeBSD" ] ; then
        pkg update && pkg upgrade -y && pkg install -y bash gcc git cmake devel/gmake devel/gdb
        echo "MK=gmake" >> $CIRRUS_ENV
    elif grep -qi "fedora" /etc/os-release ; then
        dnf upgrade -y && dnf install -y gcc git make cmake gfortran gdb libasan libubsan
    elif grep -qi "alpine" /etc/os-release ; then
        apk update && apk upgrade && apk add musl-dev gcc git make cmake gfortran gdb bash musl-dbg
    else
        apt update && apt upgrade -y && apt install -y gcc git make cmake gfortran gdb
    fi

    type gcc && gcc --version
    type gfortran && gfortran --version
    type cmake && cmake --version
    type gdb && gdb --version


  fortran_example_script: |
    ROOT_DIR=$(git rev-parse --show-toplevel)
    for SOLVER in uobyqa newuoa bobyqa lincoa cobyla ; do
        cd $ROOT_DIR/fortran/examples/$SOLVER
        export EXAMPLE_NUM=1 && $MK gtest
        export EXAMPLE_NUM=2 && $MK gtest
    done


  cmake_test_script: |
    if [ "$(uname)" == "FreeBSD" ] ; then
        echo "WARNING: CMake test is skipped on FreeBSD." >&2
        echo "The current CMake test is with gcc only; should test FreeBSD with Clang/LLVM." >&2
        exit 0
    fi

    ROOT_DIR=$(git rev-parse --show-toplevel)
    cd $ROOT_DIR

    export CC=gcc
    CFLAGS="-Wall -Wextra -Wpedantic -Werror"
    export FC=gfortran
    export FFLAGS='-Wall -Wextra -Wpedantic -Werror -fimplicit-none -ftrampoline-impl=heap -frecursive -fcheck=all -fstack-check -Wno-function-elimination'

    $FC --version
    $CC --version
    cmake --version

    cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=. -LAH -DCMAKE_C_FLAGS="${CFLAGS}" -DCMAKE_Fortran_FLAGS="${FFLAGS}" .
    cmake --build . --target install
    cmake --build . --target tests
    ctest --output-on-failure -V -E stress


  fortran_test_script: |
    ROOT_DIR=$(git rev-parse --show-toplevel)
    cd $ROOT_DIR/fortran/tests

    # Decide the solver to test by $(date + %N)
    NS=$(date +%N)
    NS=${NS#"${NS%%[!0]*}"}  # Strip leading zeros, or the shell will interpret the number as octal and fail if it contains digits 8 or 9.
    SOLVER_NUM=$((${NS:-0} % 5))  # Use 0 if completely empty
    if [ $SOLVER_NUM -eq 0 ] ; then
        SOLVER=uobyqa
    elif [ $SOLVER_NUM -eq 1 ] ; then
        SOLVER=newuoa
    elif [ $SOLVER_NUM -eq 2 ] ; then
        SOLVER=bobyqa
    elif [ $SOLVER_NUM -eq 3 ] ; then
        SOLVER=lincoa
    else
        SOLVER=cobyla
    fi
    echo $SOLVER_NUM $SOLVER

    # Decide the integer kind to test by $(date +%N)
    NS=$(date +%N)
    NS=${NS#"${NS%%[!0]*}"}  # Strip leading zeros, or the shell will interpret the number as octal and fail if it contains digits 8 or 9.
    IK=$((2**((${NS:-0} % 3) + 1)))  # Use 0 if completely empty
    echo $IK

    # Decide the real kind to test by $(date +%N)
    NS=$(date +%N)
    NS=${NS#"${NS%%[!0]*}"}  # Strip leading zeros, or the shell will interpret the number as octal and fail if it contains digits 8 or 9.
    RK=$((2**((${NS:-0} % 3) + 2)))  # Use 0 if completely empty
    echo $RK

    $MK clean && $MK gtest_i${IK}_r${RK}_d1_tst.$SOLVER


  on_failure:
